<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>웹앱</title>

<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
  .page { display: none; padding: 20px; }
  .active { display: block; }
  .button { padding: 10px 20px; background: black; color: white; border: none; cursor: pointer; }
  .input { padding: 10px; width: 250px; }
</style>
</head>
<body>

<!-- Page 1 -->
<div id="page-1" class="page active">
  <h2>시작하기</h2>
  <button class="button" onclick="goToPage('page-2')">시작</button>
</div>

<!-- Page 2: User Info -->
<div id="page-2" class="page">
  <h2>사용자 정보</h2>
  <input id="input-nickname" class="input" placeholder="닉네임" /><br/><br/>
  <select id="input-major" class="input">
    <option value="">학과 선택</option>
    <option value="건축학과">건축학과</option>
    <option value="커뮤니케이션디자인과">커뮤니케이션디자인과</option>
  </select><br/><br/>
  <button class="button" onclick="submitUserInfo()">다음</button>
</div>

<!-- Page 3: Menu -->
<div id="page-3" class="page">
  <h2><span id="display-name"></span>님 반가워요!</h2>
  <button class="button" onclick="goToPage('page-4')">게시글 보기</button><br/><br/>
  <button class="button" onclick="goToPage('page-6')">게시글 작성</button>
</div>

<!-- Page 4: Posts List -->
<div id="page-4" class="page">
  <h2>게시글 목록</h2>
  <div id="posts-container">불러오는 중...</div>
  <br/>
  <button class="button" onclick="goToPage('page-3')">뒤로</button>
</div>

<!-- Page 6: New Post -->
<div id="page-6" class="page">
  <h2>게시글 작성</h2>
  <input id="post-title" class="input" placeholder="제목" /><br/><br/>
  <textarea id="post-content" class="input" style="width:300px;height:120px;" placeholder="내용"></textarea><br/><br/>

  <label>이미지 첨부</label><br/>
  <input type="file" id="post-image" accept="image/*"><br/><br/>

  <button class="button" onclick="submitNewPost()">등록</button><br/><br/>
  <button class="button" onclick="goToPage('page-3')">취소</button>
</div>

<script>
let currentUser = null;
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwcH-3n3nERdfGPBnaY8Y728_ubbiFT7tmhiPJ0OncOU8xEPSP86ruriR93A4Fe3GaLcA/exec";  // 반드시 Apps Script 웹앱 URL로 변경

function goToPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// 사용자 정보 저장
function submitUserInfo() {
  const nickname = document.getElementById('input-nickname').value.trim();
  const major = document.getElementById('input-major').value;

  if (!nickname) return alert("닉네임을 입력해주세요!");
  if (!major) return alert("학과를 선택해주세요!");

  currentUser = { nickname, major };
  document.getElementById('display-name').textContent = nickname;
  goToPage('page-3');
}

// 이미지 → Base64 변환
function fileToBase64(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.readAsDataURL(file);
  });
}

// 게시글 업로드
async function submitNewPost() {
  const title = document.getElementById('post-title').value.trim();
  const content = document.getElementById('post-content').value.trim();
  const fileInput = document.getElementById('post-image').files[0];

  if (!title) return alert("제목을 입력하세요!");
  if (!content) return alert("내용을 입력하세요!");

  let imgBase64 = "";
  let imgName = "";

  if (fileInput) {
    imgBase64 = await fileToBase64(fileInput);
    imgName = fileInput.name;
  }

  const payload = {
    action: "addPost",
    nickname: currentUser.nickname,
    major: currentUser.major,
    title,
    content,
    image: imgBase64,
    imageName: imgName,
    timestamp: new Date().toISOString()
  };

  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const result = await res.json();

  if (result.status === "success") {
    alert("게시글이 등록되었습니다!");
    loadPosts();
    goToPage('page-4');
  } else {
    alert("오류 발생: " + result.message);
  }
}

// 게시글 목록 가져오기
async function loadPosts() {
  const res = await fetch(SCRIPT_URL + "?action=getPosts");
  const posts = await res.json();

  const container = document.getElementById("posts-container");
  container.innerHTML = "";

  posts.forEach(post => {
    const box = document.createElement("div");
    box.style.border = "1px solid #ccc";
    box.style.padding = "10px";
    box.style.marginBottom = "10px";

    box.innerHTML = `
      <h3>${post.title}</h3>
      <p>${post.content}</p>
      ${post.imageUrl ? `<img src="${post.imageUrl}" style="max-width:200px;">` : ""}
      <br/>
      <small>${post.nickname} · ${post.major}</small>
    `;

    container.appendChild(box);
  });
}

window.onload = loadPosts;
</script>
</body>
</html>
